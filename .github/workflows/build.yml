name: Build APK via Buildozer (Fixed Manual)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_apk:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Java 11 –∏ Python 3.11
      - name: Set up Java and Python
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y git zip unzip build-essential wget

      # 4Ô∏è‚É£ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Buildozer 
      - name: Cache Buildozer environment
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # 5Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –ø–∞–∫–µ—Ç—ã
      - name: Install Python packages (Buildozer, Cython)
        run: pip install buildozer cython

      # 6Ô∏è‚É£ –°–±–æ—Ä–∫–∞ debug APK —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–Ω—è—Ç–∏–µ–º –ª–∏—Ü–µ–Ω–∑–∏–π
      - name: Build APK (First Run to Setup & Accept Licenses)
        # –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞—Å—Ç–∞–≤—è—Ç Buildozer 
        # –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–Ω—è—Ç—å –ª–∏—Ü–µ–Ω–∑–∏–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        env:
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç—Ç–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞—Å—Ç–∞–≤–∏—Ç Buildozer –Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å "Accept? (y/N)"
          # –°—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–µ–º–ª–µ–º—ã–º –¥–ª—è CI/CD, –≥–¥–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.
          BUILD_ANDROID_LOWER_SDK: 1
          
          # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —á—Ç–æ Buildozer –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
          ANDROIDAPI: 33 
          ANDROIDMINAPI: 21
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é Build Tools, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞
          ANDROID_BUILD_TOOLS: 34.0.0
          
        run: |
          # üí° –¢—Ä—é–∫: –í—ã–∑—ã–≤–∞–µ–º buildozer –¥–≤–∞–∂–¥—ã.
          # 1. –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ (–±–µ–∑ —Ñ–ª–∞–≥–∞ debug) –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è NDK/SDK/BuildTools 
          #    –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–Ω—è—Ç–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π –±–ª–∞–≥–æ–¥–∞—Ä—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π BUILD_ANDROID_LOWER_SDK.
          #    –ï—Å–ª–∏ —ç—Ç–æ—Ç —à–∞–≥ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –æ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç –≤—Å—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É.
          buildozer android clean
          buildozer android --bootstrap=sdl2 debug
          
      # 7Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-APK
          path: bin/*.apk
